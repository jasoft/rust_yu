# Rust + Tauri 专业级 Windows 卸载工具 核心设计建议

针对资深开发者，以下内容完全聚焦Windows卸载工具的专业级核心能力、Rust/Tauri架构最佳实践、系统深度适配与安全合规，避开入门级demo思路，直接覆盖工业级工具的核心痛点与实现方案。

## 一、核心架构设计（专业级分层，彻底解耦）

### 1. 不可动摇的分层原则

完全隔离核心能力与UI层，杜绝把系统逻辑耦合到Tauri Command中，架构如下：

| 层级        | 技术实现                      | 核心职责                                                    | 设计要求                                                               |
| ----------- | ----------------------------- | ----------------------------------------------------------- | ---------------------------------------------------------------------- |
| 核心引擎层  | 纯Rust实现，零Tauri依赖       | 卸载核心逻辑、系统扫描、快照对比、残留清理、Windows API封装 | 可独立编译为CLI工具，100%可单测，与GUI完全解耦，支持跨进程复用         |
| Tauri适配层 | Rust + Tauri IPC              | 权限桥接、IPC命令转发、事件推送、子进程管理、参数校验       | 仅做能力暴露与安全管控，不实现任何业务逻辑，严格过滤前端传入的所有参数 |
| 前端UI层    | Vue/React/Svelte + TypeScript | 交互渲染、状态管理、进度展示、用户操作入口                  | 零系统操作逻辑，所有能力均通过IPC调用后端，仅做数据展示与事件触发      |

### 2. 高权限架构最佳实践（安全红线）

**绝对禁止Tauri主进程以管理员权限运行**，WebView2在高权限下存在致命安全风险，且会引发大量Windows兼容性问题。

- 正确方案：低权限主进程（Tauri）+ 高权限Rust子进程架构
- 主进程：仅运行普通用户权限，负责UI渲染、IPC通信、任务调度，无任何高危系统操作
- 子进程：纯Rust编写的CLI工具，与核心引擎层复用代码，仅在需要时以管理员权限启动，通过Windows命名管道（Named Pipe）与主进程通信，执行卸载、注册表修改、文件删除等高危操作
- 通信安全：管道通信采用带签名的二进制协议（bincode），一次性token校验，防止恶意进程注入伪造命令

## 二、Rust后端核心引擎（专业工具的灵魂）

### 1. 依赖选型（稳定、原生、工业级）

| 能力域          | 选型建议                            | 避坑提醒                                                                                                                             |
| --------------- | ----------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------ |
| Windows API绑定 | 微软官方`windows` crate             | 彻底弃用停止维护的`winapi`，`windows` crate支持全量Win32/WinRT API，类型安全，更新及时，是唯一专业级选择                             |
| 异步运行时      | `tokio`（与Tauri默认 runtime 对齐） | 所有耗时操作（扫描、卸载、备份）必须异步化，用`CancellationToken`实现任务暂停/取消，绝对禁止同步阻塞Tauri主线程                      |
| 错误处理        | `thiserror` + `anyhow`              | 用`thiserror`定义全场景自定义错误类型（API调用失败、权限不足、文件占用等），覆盖所有错误上下文，禁止`unwrap()`/`expect()`，杜绝panic |
| 日志系统        | `tracing` + `tracing-appender`      | 结构化日志，支持分级过滤、滚动归档、日志导出，全操作留痕（扫描路径、删除项、卸载返回值、错误信息），方便用户排查问题                 |
| 数据持久化      | `rusqlite`                          | 轻量嵌入式SQLite，用于缓存软件清单、快照数据、备份记录、扫描白名单，避免每次启动全量枚举系统，大幅提升启动速度                       |
| 并行计算        | `rayon`                             | 用于文件/注册表并行扫描，充分发挥Rust的并发优势，同时限制并行度，避免占用过多系统资源导致用户卡顿                                    |

### 2. Windows全场景软件适配（专业级核心能力）

普通工具仅读取注册表Uninstall项，专业级必须覆盖Windows全类型软件，且采用原生API而非命令行调用，保证可控性与兼容性。

#### （1）MSI安装包（Windows Installer）

- 核心实现：直接调用`msi.dll`原生API，而非`msiexec.exe`命令行
  - 枚举：`MsiEnumProductsExW`枚举全量已安装MSI产品，比注册表更准确（覆盖特殊安装的MSI实例）
  - 卸载：`MsiConfigureProductExW`实现可控卸载，支持进度回调、静默模式、回滚控制、重启拦截
  - 细节：解析MSI数据库，提取完整安装清单（文件、注册表、服务、组件），为残留清理提供基准数据

#### （2）Win32桌面应用（Inno Setup/NSIS/InstallShield等）

- 枚举覆盖：3个核心注册表路径，缺一不可
  - 64位：`HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall`
  - 32位：`HKLM\SOFTWARE\WOW6432Node\Microsoft\Windows\CurrentVersion\Uninstall`
  - 用户级：`HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall` + 全用户`HKU`分支枚举
- 静默卸载适配：自动识别安装器类型，拼接原生静默参数，解决99%的静默卸载失败问题
  - Inno Setup：`/verysilent /norestart /suppressmsgboxes`
  - NSIS：`/S`
  - InstallShield：`/s /v"/qn /norestart"`
  - 优先使用`QuietUninstallString`，无静默参数时自动注入适配参数

#### （3）UWP/APPX/MSIX应用（微软商店应用）

- 核心实现：调用WinRT `PackageManager` API，禁止直接删除文件夹
  - 枚举：`FindPackagesForUser()`枚举全量已安装包，区分用户包与系统内置包
  - 卸载：`RemovePackageAsync()`实现可控卸载，自动处理依赖包，禁止强制卸载系统核心包（内置白名单防护）

#### （4）便携/绿色软件

- 核心能力：安装快照监控 + 手动目录扫描
  - 快照对比：安装前对文件系统、注册表、服务、计划任务做全量快照，安装后生成差异报告，100%还原安装轨迹，实现无残留卸载
  - 增量扫描：基于NTFS USN日志实现文件系统增量快照，无需全量遍历磁盘，速度提升10倍以上
  - 手动适配：支持用户添加便携软件目录，自动扫描关联的注册表项、快捷方式、配置文件，生成卸载清单

### 3. 专业级残留清理引擎

这是区分玩具工具与工业级工具的核心，必须实现多维度、安全、可回溯的清理能力。

#### （1）全维度残留扫描

基于软件基准信息（安装目录、发行商、产品名、CLSID、进程名），覆盖全系统扫描域：

- 文件系统：Program Files、ProgramData、AppData（Local/Roaming/LocalLow）、Temp目录、系统驱动目录、共享DLL、用户目录隐藏文件夹
- 注册表：CLSID/ProgID/TypeLib、App Paths、Shell扩展/右键菜单、启动项、服务/驱动项、防火墙规则、文件关联、环境变量
- 系统组件：Windows服务、内核驱动、计划任务（ITaskService API）、防火墙入站/出站规则、系统还原点、WMI提供程序

#### （2）安全机制（红线要求）

- 白名单防护：内置微软官方系统文件/注册表项白名单，基于数字签名+文件哈希双重校验，禁止误删系统核心组件
- 先备份后删除：所有待删除项先压缩备份（zip/7z，支持加密），备份文件带SHA256完整性校验，支持一键全量回滚
- 占用处理：采用微软官方`Restart Manager API`检测文件占用，支持强制结束占用进程，或通过`MoveFileExW`实现重启后删除
- 操作审计：所有清理操作全日志留痕，支持导出操作报告，满足企业级审计要求

## 三、Tauri前端与IPC设计（安全、流畅、专业）

### 1. IPC安全设计（不可突破的红线）

- 严格的命令管控：`tauri.conf.json`中仅暴露必要的Command，禁止全量能力暴露，每个Command必须做参数合法性校验（比如路径白名单、操作权限校验）
- 事件驱动而非轮询：扫描/卸载进度、实时日志通过Tauri事件系统从后端推送到前端，而非前端轮询，保证UI流畅性与实时性
- 类型完全对齐：用`ts-rs` crate自动将Rust的struct生成TypeScript类型定义，保证前后端参数/返回值类型100%一致，杜绝类型错误
- 极致严格的CSP：`tauri.conf.json`中配置内容安全策略，禁止内联脚本、禁止eval、禁止远程资源加载（更新除外），彻底防范XSS漏洞
- 大文件传输优化：图标、快照等大数据禁止通过JSON传输，采用Tauri资产协议或临时文件方案，避免IPC阻塞与内存暴涨

### 2. 专业级UI功能模块

针对卸载工具的核心场景，UI必须满足专业用户的效率需求，核心模块如下：

1. **软件列表页**：支持分页、多维度筛选（安装类型/时间/大小/发行商）、批量选择、批量卸载，支持右键菜单（打开安装目录/注册表项、查看详情、备份、强制卸载），软件图标通过Windows原生API获取并缓存
2. **软件详情页**：展示完整安装清单、关联的服务/驱动/计划任务、卸载历史、备份记录，支持单独清理指定组件
3. **扫描清理页**：实时展示扫描进度，支持暂停/取消，扫描结果分类展示，支持用户手动勾选清理项，一键备份/清理/回滚
4. **安装监控页**：支持安装前后快照对比，生成完整安装轨迹报告，实现绿色软件100%无残留卸载
5. **专业工具集**：强制文件删除、注册表清理、启动项管理、服务管理、右键菜单清理、文件关联修复等附加工具
6. **设置页**：自定义扫描规则、白名单管理、备份路径配置、日志级别、静默参数自定义、自动更新配置

### 3. 体验与兼容性优化

- 启动速度优化：启动时仅渲染UI，软件清单枚举、缓存加载放到后台异步任务，懒加载非核心模块，实现秒开
- 系统主题适配：监听Windows系统主题变化，自动切换暗黑/浅色模式，符合Windows设计规范
- 无障碍支持：适配屏幕阅读器、全键盘导航、高对比度模式，满足专业级应用的无障碍要求
- 跨架构适配：支持x86_64、ARM64（Windows on ARM），Rust交叉编译生成对应架构二进制，适配Surface等ARM设备

## 四、安全、合规与分发（工业级必备）

### 1. 安全与兼容性红线

- 数字签名：所有二进制文件（主程序、子进程、安装包）必须使用EV代码签名证书签名，绕过Windows SmartScreen拦截，提升用户信任度与杀毒软件兼容性
- 杀毒软件适配：避免使用敏感API（远程进程注入、内存读写等），与主流杀毒厂商完成白名单适配，解决系统工具高频误报问题
- 系统兼容性：最低兼容Windows 10 1809（与Tauri WebView2最低要求对齐），覆盖Windows 10/11全主流版本，在干净系统、域环境、虚拟机中完成全场景测试
- 隐私合规：所有用户数据仅本地存储，禁止无授权上传用户信息，符合GDPR、个人信息保护法等合规要求

### 2. 工程化与分发

- 测试体系：核心引擎层实现100%单元测试覆盖，用`mockall`模拟Windows API返回值，测试全量错误场景；搭建虚拟机集成测试环境，验证全类型软件卸载流程；用`tauri-driver` + Playwright实现UI端到端测试
- CI/CD流水线：基于GitHub Actions/GitLab CI实现自动化构建、测试、签名、打包、发布，支持多架构交叉编译，避免手动打包的人为错误
- 安装包制作：用`cargo-wix`/Inno Setup制作Windows安装包，支持静默安装、自定义路径、右键菜单集成；同时提供便携版本，满足免安装需求
- 自动更新：启用Tauri内置updater，更新包必须做签名校验，支持增量更新，保证用户快速获取bug修复与功能迭代

## 五、高频踩坑避坑指南

1. **Windows API编码坑**：所有Windows API必须使用W后缀的宽字符版本，用`HSTRING`/`PWSTR`处理字符串，杜绝ANSI版本，避免中文乱码与兼容性问题
2. **句柄泄漏坑**：用Rust RAII机制封装所有Windows内核对象句柄（注册表、文件、管道、服务），实现Drop trait自动关闭，杜绝长时间运行的句柄泄漏
3. **异步阻塞坑**：Tauri同步Command会阻塞主线程，所有耗时操作必须用异步Command + tokio任务，绝对禁止在主线程执行扫描、卸载等耗时操作
4. **MSI卸载坑**：禁止直接调用msiexec.exe，原生API可实现更精准的进度控制、错误捕获与回滚处理，解决特殊MSI实例卸载失败问题
5. **UWP卸载坑**：禁止直接删除UWP包目录，必须用PackageManager API，否则会导致微软商店、系统组件异常，同时严格禁止用户误删系统内置UWP包
